<script type="module">

  const backendURL = 'https://foodiepages.herokuapp.com'

  {% comment %} 
  'http://localhost:8080'
  'https://foodiepages.herokuapp.com'
  {% endcomment %}

  {% comment %}

  ! SOS INVENTORY FUNCTIONS

  {% endcomment %}

  window.getSosCustomers = async (id) => {
    const url = id ? `${backendURL}/api/sos_customer?id=${id}` : `${backendURL}/api/sos_customer`;

    try {
      const response = await fetch(url);
      
      if (response.status === 400) {
        console.log('400', response);
        throw new Error('Bad Request');
      }
      if (response.status === 401) {
        console.log('401', response);
        throw new Error('Unauthorized');
      }
      if (response.status === 404) {
        window.generateError(`Something went wrong while trying to get your SOS Customers. Please contact your developer.`);
        throw new Error('Not Found');
      }
      if (response.status >= 500) {
        console.log('500', response);
        throw new Error('Internal Server Error');
      }
      
      const pageData = await response.json();
      return pageData;
    } catch (error) {
      console.error('Error fetching SOS customers:', error);
      throw error;
    }
  }

  window.getSosItems = async (ids) => {

    {% comment %} if ids is an array turn into a comma separated list {% endcomment %}
    if (Array.isArray(ids)) {
      ids = ids.join(',');
    }

    const url = ids ? `${backendURL}/api/get-sos-item?ids=${ids}` : `${backendURL}/api/get-sos-item`;

    try {
      const response = await fetch(url);
      
      if (response.status === 400) {
        console.log('400', response);
        throw new Error('Bad Request');
      }
      if (response.status === 401) {
        console.log('401', response);
        throw new Error('Unauthorized');
      }
      if (response.status === 404) {
        window.generateError(`Something went wrong while trying to get your SOS Customers. Please contact your developer.`);
        throw new Error('Not Found');
      }
      if (response.status >= 500) {
        console.log('500', response);
        throw new Error('Internal Server Error');
      }
      
      const pageData = await response.json();
      return pageData;
    } catch (error) {
      console.error('Error fetching SOS items:', error);
      throw error;
    }
  }

  window.getSosSalesOrder = async (query) => {
    query = query.replace('#', '');

    const url = query ? `${backendURL}/api/get-sale-orders?query=${query}` : `${backendURL}/api/get-sale-orders`;
  
    try {
      const response = await fetch(url);
      
      if (response.status === 400) {
        console.log('400', response);
        throw new Error('Bad Request');
      }
      if (response.status === 401) {
        console.log('401', response);
        throw new Error('Unauthorized');
      }
      if (response.status === 404) {
        window.generateError(`Something went wrong while trying to get your SOS Customers. Please contact your developer.`);
        throw new Error('Not Found');
      }
      if (response.status >= 500) {
        console.log('500', response);
        throw new Error('Internal Server Error');
      }
      
      const pageData = await response.json();
      return pageData;
    } catch (error) {
      console.error('Error fetching SOS sales order:', error);
      throw error;
    }
  }

  {% comment %}  

  ! SHOPFIY FUNCTIONS

  {% endcomment %}

  window.getShopifyProducts = async (ids) => {

    try {
      const response = await fetch(`${backendURL}/api/get-shopify-collections`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(ids)
      });
      
      if (response.status === 400) {
        console.log('400', response);
        throw new Error('Bad Request');
      }
      if (response.status === 401) {
        console.log('401', response);
        throw new Error('Unauthorized');
      }
      if (response.status === 404) {
        console.log('404', response);
        throw new Error('Not Found');
      }
      if (response.status >= 500) {
        console.log('500', response);
        throw new Error('Internal Server Error');
      }
      
      const pageData = await response.json();
      
      if (!pageData.data.products) {
        return 'No Products';
      }

      const products = pageData.data.products.filter(p => p.status === 'active')

      return products;
    } catch (error) {
      console.error('Error fetching Shopify products:', error);
      throw error;
    }
  }
  
  // Function to fetch a specific product by SKU
  window.getProductBySku = async (sku) => { 
    try {
      console.log('Fetching product by SKU:', sku);
      const response = await fetch(`${backendURL}/api/get-product-by-sku?sku=${encodeURIComponent(sku)}`);
      
      if (response.status === 400) {
        console.log('400', response);
        throw new Error('Bad Request');
      }
      if (response.status === 401) {
        console.log('401', response);
        throw new Error('Unauthorized');
      }
      if (response.status === 404) {
        console.log('404', response);
        return null;
      }
      if (response.status >= 500) {
        console.log('500', response);
        throw new Error('Internal Server Error');
      }
      
      const data = await response.json();
        
      if (data.data && data.data.product) {
        console.log('Found product by SKU:', data.data.product.title);
        return data.data.product;
      }
      
      console.log('No product found by SKU:', sku);
      return null;
    } catch (error) {
      console.error('Error fetching product by SKU:', error);
      return null;
    }
  }

  {% comment %}  

  ! AIRTABLE FUNCTIONS

  {% endcomment %}

  window.createAirtableEntries = async ({
    customerId,
    campaignName,
    formState,
    giftState,
  }) => {
    if (!Array.isArray(formState)) {
      formState = [formState];
    }
  
    try {
      const response = await fetch(
        `${backendURL}/api/airtable-create-campaign-entry?campaignName=${campaignName}&customerId=${customerId}`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            formState,
            giftState,
          })
        }
      );
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const pageData = await response.json();
      return [pageData];
    } catch (error) {
      console.error('Error creating Airtable entries:', error);
      throw error;
    }
  };  
  

  window.airtableCreateCampaign = async ({ inputs, formArray, gifts }) => {

    try {
      const response = await fetch(`${backendURL}/api/airtable-create-campaign`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          inputs,
          formArray,
          gifts
        })
      });
      
      if (response.status === 400) {
        console.log('400', response);
        throw new Error('Bad Request');
      }
      if (response.status === 401) {
        console.log('401', response);
        throw new Error('Unauthorized');
      }
      if (response.status === 404) {
        generateError(`Something went wrong while trying to get your SOS Customers. Please contact your developer.`);
        throw new Error('Not Found');
      }
      if (response.status >= 500) {
        console.log('500', response);
        throw new Error('Internal Server Error');
      }
      
      const pageData = await response.json();
      return pageData;
    } catch (error) {
      console.error('Error creating Airtable campaign:', error);
      throw error;
    }
  }

  window.getAirtableTableById = async ({ campaignNameParam, clientIdParam }) => {
    
    try {
      const response = await fetch(
        `${backendURL}/api/airtable-admin-base?campaignName=${campaignNameParam}&customerId=${clientIdParam}`
      );
      
      if (response.status === 400) {
        console.log('400', response);
        throw new Error('Bad Request');
      }
      if (response.status === 401) {
        console.log('401', response);
        throw new Error('Unauthorized');
      }
      if (response.status === 404) {
        generateError(`Something went wrong while trying to initiate your gift selection (Campaign Name: ${campaignNameParam}). Please contact your administrator.`);
        throw new Error('Not Found');
      }
      if (response.status >= 500) {
        console.log('500', response);
        throw new Error('Internal Server Error');
      }
      
      const pageData = await response.json();
      return pageData;
    } catch (error) {
      console.error('Error fetching Airtable table:', error);
      throw error;
    }
  } 











</script>
