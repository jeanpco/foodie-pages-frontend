<style>
  sticky-header,
  #shopify-section-footer,
  .announcement-bar {
    display: none !important;
  }

  .loading {
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background: var(--color-white);
    z-index: 2;
  }
</style>

{% comment %} 
  @TODO: Only show the publish product (active) when fetching product from Shopify
  @TODO: Do you mean this: https://www.foodiepages.ca/pages/form?client=71&campaign=employee-appreciation-2023? Right now what I could do is to open it inside another tab after creation?
{% endcomment %}

{% render 'campaign-form__loading-icon' %}
{% render 'campaign-form__header' %}
{% render 'campaign-form__body' %}
{% render 'campaign-form__footer' %}

<script type="module">
  
  import wretch from 'https://cdn.skypack.dev/wretch/dist/bundle/wretch.all.min.mjs'

  function removeSpacesAndBackslashes(str) {
    return str.replace(/\s/g, '').replace(/\\/g, '');
  }

  const generateError = (message) => {
    const loadingSpinner = document.querySelector('.loading-spinner')
    const getLoadingMessage = document.querySelector('.loading-container p')
    loadingSpinner.style.display = 'none'
    getLoadingMessage.innerHTML = message
  }

  const initCampaignForm = async () => {

    {% comment %} !NOTE: Backend URL need to be set back to the production URL once done with testing / local development. {% endcomment %}

    const backendURL = 'http://localhost:8080'
    {% comment %} 'https://foodiepages.herokuapp.com' {% endcomment %}
    {% comment %} 'http://localhost:8080' {% endcomment %}

    // get all url params
    {% comment %} client=364&campaign=christmas-campaign {% endcomment %}
    const urlParams = new URLSearchParams(window.location.search);
    const campaignNameParam = urlParams.get('campaign');
    const clientIdParam = urlParams.get('client');

    const pageData = await wretch(
      `${backendURL}/api/airtable-admin-base?campaignName=${campaignNameParam}&customerId=${clientIdParam}`
    ) // Base url
      // Authorization header
      .get() // GET request
      .badRequest((err) => {
        console.log('400', err)
        throw err;
      }) // Handle 400 errors
      .unauthorized((err) => {
        console.log('401', err)
        throw err;
      }) // Handle 401 errors
      .notFound((err) => {

        generateError(`Something went wrong while trying to initiate your gift selection (Campaign Name: ${campaignNameParam}). Please contact your administrator.`)
        throw err;
      }) // Handle 404 errors
      .internalError((err) => {
        console.log('500', err)
        throw err;
      }) // Handle 500 errors
      .res((res) => res.json()); // Parse response as JSON

    const rawData = pageData.data.campaignRow.fields

    const data = {
      {% comment %} header {% endcomment %}
      shippingDetails: rawData['Shipping Details'],
      campaignName: rawData['Campaign Name'],
      giftMessage: rawData['Gift Message'],
      companyLogo: rawData['Company Logo'] && rawData['Company Logo'][0].url,
      pageURL: rawData['Page URL'],
      {% comment %} body {% endcomment %}
      products: JSON.parse(removeSpacesAndBackslashes(rawData.products)),
      numberOfSelectableGifts: rawData['Number of selectable gifts'],
      {% comment %} footer {% endcomment %}
      formStructure: JSON.parse(removeSpacesAndBackslashes(rawData['Form Structure'])),
      formButtonText: rawData['Form Button Text'],
      endDate: rawData['End Date'],
    }

    window.campaignForm.buildHeader && window.campaignForm.buildHeader({
      imageUrl: data.companyLogo,
      title: data.campaignName, 
      body: data.giftMessage,
    })

    window.campaignForm.buildBody && window.campaignForm.buildBody({
      products: pageData.data.shopifyProducts,
      numberOfSelectableGifts: data.numberOfSelectableGifts,
    })

    window.campaignForm.buildFooter && window.campaignForm.buildFooter({
      formStructure: data.formStructure,
      formButtonText: data.formButtonText,
      products: pageData.data.shopifyProducts,
      shippingDetails: data.shippingDetails,
      endDate: data.endDate,
    })

    window.campaignForm.initLoading(false)
  }

  window.addEventListener('load', async () => {
    try {
      await initCampaignForm()
    } catch (error) {
      console.log(error)
      generateError(`Something went wrong while trying to initiate your gift selection. </br>Please contact your administrator.`)
    }
  })
</script>
